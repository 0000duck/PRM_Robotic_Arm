# 双臂demo顶层设计

## 需要考虑项

* 双臂的放置
    - 有足够接触面积
    - 不可动部分永不接触
    - 模型转换
    - ~~横放：高低放~~
    - **两臂末端工具不一样长**
    - 间距650可以满足带吸嘴不碰，600不行
* 栅格数量精度
* edge数量
* 默认任务
    - pick and place

* 主板选型及个数
    - 一块主板不需要通信
    - 两块主板简单通信可以有效分割任务区，进行解耦





## 需要攻克的技术
* 蓝牙xbox协议
* 模型转换，生成
    - 当前位置转模型栅格
    - 下一帧路径转栅格
    - 障碍物转栅格
    - 障碍物纵向控制转栅格
* 障碍通信
    - 建议单板完成
* risc-V
* 机械臂校准方案
* 解耦
* 硬件方案
    - 功率输电
    - 隔离技术
    - 驱动划分

## 避障分层
* 硬件驱动IP
* 步进软件驱动
* 步进驱动顶层API
* 缓冲层
* 实时规划层
* 传感层
* 用户层

## 遥控分层
* 硬件驱动IP
* 步进软件驱动
* 步进驱动顶层API
* 缓冲层
* 用户层

## 行动纲要
* 步进顶层API评估
* 安装方式评估
* 产生基础任务edge
* 生成grid
* 虚拟障碍运行
* 障碍臂转栅格
* 遥控


## 避障部分ip设计
<!-- #### 设计原则
* ps-pl接口传送带宽尽可能小，减少处理器访存时间


--------------------
#### 接口

* 输入
    - 主机械臂姿态、轨迹
    - 预测时间范围
    - 遥控障碍机械臂姿态、（轨迹or自行预测）
    - 附加传送带速度，障碍物编码
* 输出
    - 主机械臂下一步决策
        + 保持轨迹
        + 调整轨迹速度
        + 撤销轨迹（如何撤销？新PRM结果？） -->

--------------------

#### 模块

<!-- 
* prm（PRM规划路径，在正常状况下绝对安全，发生意外入侵时不一定安全，非微调阶段使用）
    - 预先生成的姿态（pose），这些姿态后三关节可以先定义好，即随机采样终端位置，解IK
    - 根据代价在这些姿态中切换序列
    - 输入：当前位置，目标位置，障碍区域，预测时间范围
    - 输出：安全的路径序列
    - 1. 障碍区域时间扩展
        + 打拍遍历所有配置
        + 配置激活栅格
    - 2. 最近价值路径碰撞检测
        + 打拍遍历关节步进
        + 配置激活栅格
        + 栅格检测
    - 3. edge连成path
        + 价值计算，之前的硬件优化策略？

* 实时监控模块
    - 使用于意外入侵，除去prm最终ik微调阶段，需要实时调用
    - 输入：未来一段时间的路径（多拍输入）；当前障碍物的位置及相应预测时间
    - 输出：当前路径是否安全，可否加速调整，是否需要撤销
    - 1. 输入路径对应姿态（或逻辑）(大寄存器)
        + 打拍遍历关节步进
        + 配置激活栅格
    - 2. 障碍区域时间扩展（大寄存器）
        + 打拍遍历所有配置
        + 配置激活栅格
        + 直到碰撞或时间耗尽
            * 碰撞：拿到时间
            * 时间耗尽：安全
* 姿态时间预测路径范围
* 路径预测栅格
* 姿态转栅格
* 栅格并行碰撞检测


#### 资源
* 使用5：5：6 精度1.5cm
* 碰撞检测单元，可以不做那么大，多次打拍 -->


#### pose选取
* 关键点 (不带方块末端)
    - 100,300,100
    - 100,-300,100

    - 350,100,100
        + 0.278 -1.557 0.681 0 0.877 -6.0048829945846816
    - 350,-100,100
    - 200,-100,100
    - 200,100,100
    - 350,50,100
        + 0.142 -1.522 0.586 0 0.936 -6.141285598985629
    - 350,-50,100
    - 200,-50,100
    - 200,50,100
        + 0.245 -1.333 -0.295 0 1.628 0.24497866312686414
* 随机点
    - 100 ,300 ,400
    - 终端坐标预先定义为：10 * 24 * 12，将产生7992条edge，直接编码，相邻联通有效

#### edge长度
* 5+5+5 15bit 400 * 400 * 400 区域
* 采样8192个edge，吃DDR256MB


#### 路线
* 定义9个关键点，包括8个工作点和2个安全点
* 均匀定义
    - 100MS
        + 1：0.289
        + 2：0.047
        + 3：0.174
